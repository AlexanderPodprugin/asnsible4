# asnsible4

У нас есть задача:
---
1. Настроить консул ( использовать уже готовую роль и инветори).
2. База данных должна быть проинициализирована на выделенных дисках (в Vargrantfile они уже подключены). VG должна называться pg, LV pg_data и pg_wal соответственно. Точки монтирования разделов /pgsql/pg_data и /pgsql/pg_wal. Файловая система для обоих LVM ext4.
3. БД должна находиться в папке /pgsql/pg_data/14. WAL архивы должны находиться в папке /pgsql/pg_wal/14.
4. На серверах pg1 и pg2 настроить оркестратор репликации Patroni (пакет в архиве).
5. С помощью утилиты vip-manager обеспечить настройку VIP адреса на мастер сервере. Напоминаю, что в конфиге vip-manager необходимо настроить подключение по DCS Consul. IP адрес подключения 127.0.0.1:8500. Так же нужно будет указать consul_token, переменную которого можно взять в роли consul.
6. В Postgres залить уже знакомую нам БД small из https://edu.postgrespro.ru/demo-small-20161013.zip

Решение задачи:
---
    Проверяем Vagrantfile и исправляем данные, которые нам необходимы
    Запускаем Vagrantfile. После его завершения запускаем consul.play.

#Start Vagrantfile
`vagrant up`

#Start consul.play
`ansible-playbook consul.play`

    Открываем и редактируем hosts(inventory)-чтобы ansible мог управлять нашими хостами.
    Открываем и редактириуем ansible.cfg-чтобы указать наш inventory файл со всеми нужными нам параметрами.
    Создаем папку(roles) где будут хранится все playbooks и конифуграции для наших clients.
        Папка с конфигурацей backend-server: server
            Создаем папку handlers, а в ней playbook, на который мы будем иногда обращаться - чтобы перезагрузить pgl
            Создаем папку tasks, а в ней playbook, который будет стянет и скачает все необходимые пакеты: vip-manager, patroni. Указываем путь куда установить конфигурацию для pgl и vip-manager и запускаем все необходимое.
            Создадим папку vars, где будут хранится все переменные которые испольюзуются во многих файлах и могут изменится при необходимости. Тем самым мы автоматизируем весь процесс. В нашем случае у нас будут переменные: порты для прослушивания и для подключения pgl.
    Запускаем sirius.yml, в котором прописано к каким hosts принадлежат папки

`ansible-playbook sirius.yml`


Если у тебя все работает, можешь поехать в Абхазию, чтобы покушать хачапур и мамалыгу)
